{% extends 'base.html' %}
{% block content %}
<h2 class="title is-4 has-text-centered mb-5">ðŸ“Š Your Mood Entries</h2>

<!-- Chart -->
<div class="mb-5">
  <canvas id="moodChart" height="120"></canvas>
</div>

<!-- Mood Table -->
<div class="table-container">
  <table class="table is-striped is-bordered is-fullwidth is-hoverable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Mood</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for mood in moods %}
      <tr>
        <!-- <td>{{ mood[1] }}</td> -->
        <td>{{ mood[1]|datetime_format }}</td>

        <td>
          {% if mood[2] == 'Happy' %} ðŸ˜Š Happy
          {% elif mood[2] == 'Sad' %} ðŸ˜¢ Sad
          {% elif mood[2] == 'Angry' %} ðŸ˜  Angry
          {% elif mood[2] == 'Excited' %} ðŸ¤© Excited
          {% elif mood[2] == 'Calm' %} ðŸ˜Œ Calm
          {% else %} {{ mood[2] }} {% endif %}
        </td>
        <td>{{ mood[3] }}</td>
        <td>
          <a href="{{ url_for('edit_entry', id=mood[0]) }}" class="button is-info is-small mr-2">Edit</a>
          <a href="{{ url_for('delete_entry', id=mood[0]) }}" class="button is-danger is-small">Delete</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Chart.js Script -->
<script>
  const moodLabels = [{% for m in moods %}"{{ m[1] }}", {% endfor %}];

  const moodToValue = {
    'Happy': 5,
    'Excited': 4,
    'Calm': 3,
    'Sad': 2,
    'Angry': 1
  };

  const moodData = {
    labels: moodLabels,
    datasets: [{
      label: 'Mood Level Over Time',
      data: [
        {% for m in moods %}
        "{{ m[2] }}",
    {% endfor %}
      ].map(mood => moodToValue[mood] || 0),
    fill: false,
      borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
          pointRadius: 5,
            pointHoverRadius: 7,
              tension: 0.2
    }]
  };

  const config = {
    type: 'line',
    data: moodData,
    options: {
      responsive: true,
      scales: {
        y: {
          min: 0,
          max: 6,
          ticks: {
            stepSize: 1,
            callback: function (value) {
              const labels = {
                1: 'ðŸ˜  Angry',
                2: 'ðŸ˜¢ Sad',
                3: 'ðŸ˜Œ Calm',
                4: 'ðŸ¤© Excited',
                5: 'ðŸ˜Š Happy'
              };
              return labels[value] || '';
            }
          },
          title: {
            display: true,
            text: 'Mood'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Date'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function (context) {
              const val = context.parsed.y;
              const labels = {
                1: 'ðŸ˜  Angry',
                2: 'ðŸ˜¢ Sad',
                3: 'ðŸ˜Œ Calm',
                4: 'ðŸ¤© Excited',
                5: 'ðŸ˜Š Happy'
              };
              return 'Mood: ' + (labels[val] || val);
            }
          }
        }
      }
    }
  };

  const ctx = document.getElementById('moodChart').getContext('2d');
  new Chart(ctx, config);
  // <!-- âœ… Add Spinner/Toast JavaScript -->

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('loading-modal');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const deleteToast = toast.querySelector('.delete');

    deleteToast.addEventListener('click', () => {
      toast.classList.add('is-hidden');
    });

    function showToast(message, success = true) {
      toast.classList.remove('is-hidden', 'is-success', 'is-danger');
      toast.classList.add(success ? 'is-success' : 'is-danger');
      toastMessage.textContent = message;
    }

    // DELETE ACCOUNT
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    if (deleteAccountBtn) {
      deleteAccountBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Are you sure you want to delete your account? This action is irreversible.')) return;

        modal.classList.add('is-active');
        try {
          const res = await fetch(deleteAccountBtn.getAttribute('href'), { method: 'DELETE' });
          const data = await res.json();
          modal.classList.remove('is-active');

          if (data.success) {
            showToast('Account deleted successfully.', true);
            // Redirect after a short delay
            setTimeout(() => {
              window.location.href = '/logout';
            }, 1500);
          } else {
            showToast(data.message || 'Failed to delete account.', false);
          }
        } catch {
          modal.classList.remove('is-active');
          showToast('Something went wrong.', false);
        }
      });
    }

    // EDIT ENTRY FORM SUBMISSION (AJAX)
    const editForm = document.getElementById('edit-entry-form');
    if (editForm) {
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        modal.classList.add('is-active');
        const url = editForm.action;
        const formData = new FormData(editForm);

        try {
          const res = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
          });
          const data = await res.json();
          modal.classList.remove('is-active');

          if (data.success) {
            showToast('Mood updated successfully.', true);
            // Optionally redirect back after a delay
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1200);
          } else {
            showToast(data.message || 'Failed to update mood.', false);
          }
        } catch {
          modal.classList.remove('is-active');
          showToast('Something went wrong.', false);
        }
      });
    }

    // DELETE NOTE (same handler as your mood delete but generalized)
    document.querySelectorAll('.button.is-danger').forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Are you sure you want to delete this entry?')) return;

        const url = button.getAttribute('href');
        const row = button.closest('tr');

        modal.classList.add('is-active');
        try {
          const res = await fetch(url, { method: 'DELETE' });
          const data = await res.json();
          modal.classList.remove('is-active');

          showToast(data.message || (data.success ? 'Entry deleted.' : 'Delete failed.'), data.success);

          if (data.success && row) row.remove();
        } catch {
          modal.classList.remove('is-active');
          showToast('Something went wrong.', false);
        }
      });
    });
  });
</script>

{% endblock %}